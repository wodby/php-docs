# Local environment with Docker4PHP

Docker4PHP is an open-source project ([GitHub page](https://github.com/wodby/docker4php)) that provides pre-configured `docker-compose.yml` file from to spin up local environment on Linux, Mac OS X and Windows. 

## Requirements

* Install Docker ([Linux](https://docs.docker.com/engine/installation), [Docker for Mac](https://docs.docker.com/engine/installation/mac) or [Docker for Windows (10+ Pro)](https://docs.docker.com/engine/installation/windows))
* For Linux additionally install [docker compose](https://docs.docker.com/compose/install)

!!! danger "Your database data":
    You will lose MariaDB / PostgreSQL data if you run `docker-compose down`. Instead use `docker-compose stop` to stop containers. Alternatively, you can use a manual volume for mariadb data (see compose file), this way your data will always persist.

## Quick start 

1. Download `docker-compose.yml` file from the [latest stable release](https://github.com/wodby/docker4php/releases) to your PHP project root
2. Make sure`NGINX_SERVER_ROOT` (or `APACHE_SERVER_ROOT`) is set to your project public directory with `index.php` (by default `/var/www/html/public`)  
3. Optional: import existing database for [MariaDB](containers/mariadb.md#import-existing-database), for [PostgreSQL](containers/postgres.md#import-existing-database)
4. Optional: uncomment lines in the compose file to run _redis_, _solr_, etc
5. [Configure domains](#domains-configuration) 
6. Run containers: `docker-compose up -d`
7. That's it! Your php application should be up and running at [http://php.docker.localhost:8000](http://php.docker.localhost:8000). If you need to run multiple projects simultaneously see [this article](#running-multiple-projects)
8. You can see status of your containers and their logs via portainer: [http://portainer.php.docker.localhost:8000](http://portainer.php.docker.localhost:8000)

You can stop containers by executing:
```bash
docker-compose stop
```

!!! tip "Permissions issues":
    To avoid potential problems with permissions between your host and containers please follow [these instructions](#fixing-permissions-problems)

!!! tip "For macOS users":
    Out of box Docker for Mac volumes has poor performance. However there are workarounds, read more [here](#docker-for-mac-performance)

Feel free to adjust volumes and ports in the compose file for your convenience. 

## Domains Configuration

Docker4PHP uses [traefik](https://hub.docker.com/_/traefik) container for routing. By default, we use port `8000` to avoid potential conflicts but if port `80` is free on your host machine just replace traefik's ports definition in the compose file.

Add `127.0.0.1 php.docker.localhost` to your `/etc/hosts` file (some browsers like Chrome may work without it). Do the same for other default domains you might need from listed below:  

| Service      | Domain                                                                                   |
| ------------ | ---------------------------------------------------------------------------------------- |
| nginx/apache | [http://php.docker.localhost:8000](http://php.docker.localhost:8000)                     |
| pma          | [http://pma.php.docker.localhost:8000](http://pma.php.docker.localhost:8000)             |
| adminer      | [http://adminer.php.docker.localhost:8000](http://adminer.php.docker.localhost:8000)     |
| mailhog      | [http://mailhog.php.docker.localhost:8000](http://mailhog.php.docker.localhost:8000)     |
| solr         | [http://solr.php.docker.localhost:8000](http://solr.php.docker.localhost:8000)           |
| node         | [http://front.php.docker.localhost:8000](http://front.php.docker.localhost:8000)         |
| varnish      | [http://varnish.php.docker.localhost:8000](http://varnish.php.docker.localhost:8000)     |
| portainer    | [http://portainer.php.docker.localhost:8000](http://portainer.php.docker.localhost:8000) |
| webgrind     | [http://webgrind.php.docker.localhost:8000](http://webgrind.php.docker.localhost:8000)   |

You can modify domains under labels definition, e.g. `traefik.frontend.rule=Host:mailhog.php.docker.localhost`.

## Fixing Permissions Problems

To avoid potential permissions problems between host machine and containers (e.g. can't access files generated by PHP) you can add a group on your host machine with ID 82, it's a standard GID/UID for www-data user in Alpine Linux. 

### Linux

Create a new group with ID 82 and add yourself to this group.

```bash
sudo groupadd -r -g 82 alpine-www-data
sudo usermod -a -G alpine-www-data $(id -un)
```

Another solution is to use ACL mechanism, available on most of Linux distributions. 

It's available by default on Ubuntu, with ext4 filesystem (starting from 14.04 version). 
If you need more information, how to enable it on your Linux distribution, please check https://help.ubuntu.com/community/FilePermissionsACLs document. 


```bash
sudo setfacl -dR -m u:$(whoami):rwX -m u:82:rwX -m u:100:rX path_to_shared_volume
sudo setfacl -R -m u:$(whoami):rwX -m u:82:rwX -m u:100:rX path_to_shared_volume
```
Code above will make sure that both your current user and php-fpm have full permissions to all files, and nginx worker has read-only access to all files in workspace. 

### macOS

On macOS group with 82 already exists (_clamav). 

```bash
sudo dseditgroup -o edit -a $(id -un) -t user _clamav
```

### Windows

TBD

## Running Multiple Projects

[Træfik](https://docs.traefik.io) is a modern HTTP reverse proxy and load balancer made to deploy microservices with ease.
To understand the basics of Traefik it is suggested to check Træfik's documentation page: https://docs.traefik.io/

<img src="https://docs.traefik.io/img/internal.png" />

Image: Multi-domain set-up example
(Source: traefik.io)

### Steps to set up two projects on one host ##

1. Create two dirs where you will host two projects. Let's name them _site1_ and _site2_
2. Copy `docker-compose.yml` file to both dirs (_site1_ and _site2_)
3. Download `traefik.yml` file from the [latest stable release](https://github.com/wodby/docker4php/releases) to the parent dir where _site1_ and _site2_ dirs are
4. Edit `traefik.yml` and change `project1-dir_default` to `site1_default` and `project2-dir_default` to `site2_default`. Those are docker networks names that are created automatically from the dir name where docker-compose.yml is located
5. Edit site1's `docker-compose.yml` file. There are 3 main things that need to be done there:
    * In nginx service, under labels, change `traefik.backend=nginx` to `traefik.backend=site1_nginx_1`. This is the name of the container. You can see that under NAMES when your have the containers running by executing `docker ps`
    * Change `traefik.frontend.rule` from `Host:php.docker.localhost` to `Host:site1.docker.localhost`
    * Comment out all lines of `traefik` service at the bottom of the file
6. Make similar 3 changes in site2's `docker-compose.yml` file:
    * `traefik.backend=nginx` to `traefik.backend=site2_nginx_1`
    * `Host:php.docker.localhost` to `Host:site2.docker.localhost`
    * Comment out all lines of `traefik` service at the bottom of the file
7. Run `docker-compose up -d` in _site1_ and _site2_ dirs to spin up containers for both projects
8. Run stand-alone traefik `docker-compose -f traefik.yml up -d` to spin up traefik reverse proxy
9. Visit http://site1.docker.localhost and http://site2.docker.localhost in your browser

This set up also works for other Docker projects (non PHP and non docker4php based). You can replace nginx-proxy config with Traefik and get other projects all routed with on traefik container.

### Problems? ##

* Check `docker ps` to see which containers are running and check if you have set up all names correctly.
* Check `docker network ls` to check if the network names are matching.
* Run `docker-compose logs -f` in site1 or site2 to see the log of each project.

To report issues about multi-project set up with docker4php or if you have more suggestions and use-cases, please submit an issue on GitHub.

### Additional for macOS users with docker-sync:

Names of `syncs` in docker-sync.yml file must be unique per project. The recommended way is to run stand-alone docker-sync with syncs definition for all projects. Do not forget to update `src` paths for projects. 

## Docker for Mac Performance

There 2 ways how can improve performance of docker volumes on macOS:

### 1. User-guided Caching

Since Docker for Mac 17.06 there's a new `:cached` option available for volumes. You can find more information about this in [docker blog](https://blog.docker.com/2017/05/user-guided-caching-in-docker-for-mac).

Replace _codebase_ volume definition of _php_ and _nginx_/_apache_ services with the option below marked as "User-guided caching". 

### 2. Docker-sync

The core idea of this project is to use an external volume that will sync your files with a file synchronizer tool.

```bash
$ gem install docker-sync
```

1. Download `docker-sync.yml` file from the [latest stable release](https://github.com/wodby/docker4php/releases)
2. Uncomment _docker-sync_ volume definition in your compose file
3. Replace _volumes_ definition of _php_ and _nginx_/_apache_ services with the option below marked as "Docker-sync".
4. Start docker-sync: `docker-sync start`
5. In a new shell run after you started docker-sync `docker-compose up -d`

Now when you change your code on the host machine docker-sync will sync your data to php and nginx/apache containers.

For more information visit [docker-sync project page](https://github.com/EugenMayer/docker-sync).

